<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
        nav {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 8px;
            height: 56px;
        }
        .nav-logo {
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin-right: 16px;
            white-space: nowrap;
        }
        .nav-btn {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 7px 18px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.2); transform: none; box-shadow: none; }
        .nav-btn.active { background: white; color: #667eea; border-color: white; }

        /* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
        .page { display: none; padding: 24px 20px; }
        .page.active { display: block; }
        .inner { max-width: 1200px; margin: 0 auto; }

        /* ‚îÄ‚îÄ SHARED CARD ‚îÄ‚îÄ */
        .card {
            background: white; border-radius: 12px; padding: 28px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 24px;
        }
        .card h2 { color: #333; font-size: 22px; margin-bottom: 20px; }

        /* ‚îÄ‚îÄ SEARCH PAGE ‚îÄ‚îÄ */
        .search-bar { display: flex; gap: 10px; margin-bottom: 16px; }
        input[type="text"] {
            flex: 1; padding: 13px 18px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 15px; transition: border-color 0.2s;
        }
        input[type="text"]:focus { outline: none; border-color: #667eea; }
        .btn-primary {
            padding: 13px 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 15px;
            font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102,126,234,0.4); }
        .btn-primary:active { transform: translateY(0); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }

        .loading { text-align: center; padding: 20px; color: #667eea; font-weight: 600; display: none; }
        .loading.active { display: block; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #667eea;
            border-radius: 50%; width: 38px; height: 38px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error-box { background: #fee; color: #c00; padding: 14px; border-radius: 8px; margin-top: 12px; display: none; }
        .error-box.active { display: block; }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 16px; }
        .stat-item {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 18px; border-radius: 8px; text-align: center;
        }
        .stat-label { color: #666; font-size: 13px; margin-bottom: 6px; }
        .stat-value { color: #333; font-size: 22px; font-weight: 700; word-break: break-word; }

        .news-item { border-bottom: 1px solid #e8e8e8; padding: 18px 0; }
        .news-item:last-child { border-bottom: none; }
        .news-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 6px; }
        .news-time { color: #999; font-size: 13px; }
        .price-impact { padding: 3px 10px; border-radius: 4px; font-weight: 600; font-size: 13px; }
        .price-impact.positive { background: #d4edda; color: #155724; }
        .price-impact.negative { background: #f8d7da; color: #721c24; }
        .news-title { font-size: 16px; margin-bottom: 8px; }
        .news-title a { color: #333; text-decoration: none; }
        .news-title a:hover { color: #667eea; }
        .news-tags { display: flex; gap: 6px; flex-wrap: wrap; }
        .badge { background: #667eea; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; }

        /* ‚îÄ‚îÄ HALTS PAGE ‚îÄ‚îÄ */
        .halts-header {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 12px; margin-bottom: 20px;
        }
        .halts-header h2 { margin-bottom: 0; }
        .halts-meta { color: #888; font-size: 13px; margin-top: 4px; }

        .btn-reload {
            display: flex; align-items: center; gap: 7px;
            padding: 9px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 8px; font-size: 14px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-reload:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-reload:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-reload svg { transition: transform 0.6s; }
        .btn-reload.spinning svg { animation: spin 0.8s linear infinite; }

        .halts-filters {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 18px;
        }
        .filter-btn {
            padding: 5px 14px; border-radius: 20px; border: 1px solid #ddd;
            background: white; font-size: 13px; cursor: pointer; transition: all 0.15s;
            color: #555;
        }
        .filter-btn:hover { border-color: #667eea; color: #667eea; }
        .filter-btn.active { background: #667eea; color: white; border-color: #667eea; }

        .halts-table-wrap { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead th {
            background: #f8f9fa; padding: 10px 12px; text-align: left;
            font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
        }
        tbody tr { border-bottom: 1px solid #f0f0f0; transition: background 0.1s; }
        tbody tr:hover { background: #fafafa; }
        tbody td { padding: 10px 12px; color: #333; vertical-align: middle; }

        .halt-type {
            display: inline-block; padding: 3px 9px; border-radius: 4px;
            font-size: 11px; font-weight: 700; text-transform: uppercase; white-space: nowrap;
        }
        .halt-type.luld { background: #fff3cd; color: #856404; }
        .halt-type.news { background: #cce5ff; color: #004085; }
        .halt-type.regulatory { background: #f8d7da; color: #721c24; }
        .halt-type.other { background: #e2e3e5; color: #383d41; }

        .resumption-badge {
            display: inline-block; padding: 3px 9px; border-radius: 4px;
            font-size: 11px; font-weight: 600; white-space: nowrap;
        }
        .resumption-badge.pending { background: #fff3cd; color: #856404; }
        .resumption-badge.resumed { background: #d4edda; color: #155724; }
        .resumption-badge.estimated { background: #e2e3e5; color: #383d41; }
        .resumption-badge.indefinite { background: #f8d7da; color: #721c24; }

        .ticker-chip {
            font-weight: 700; color: #667eea; font-size: 14px;
        }

        .empty-state {
            text-align: center; padding: 48px 20px; color: #aaa;
        }
        .empty-state svg { margin-bottom: 12px; opacity: 0.4; }

        .halts-loading { text-align: center; padding: 40px; color: #667eea; display: none; }
        .halts-loading.active { display: block; }

        .legend {
            display: flex; gap: 16px; flex-wrap: wrap;
            padding: 14px 18px; background: #f8f9fa; border-radius: 8px;
            margin-bottom: 18px; font-size: 12px; color: #666;
        }
        .legend-item { display: flex; align-items: center; gap: 6px; }

        /* countdown timer */
        .countdown { font-weight: 600; color: #667eea; font-variant-numeric: tabular-nums; }
        .countdown.expired { color: #28a745; }

        @media (max-width: 600px) {
            .btn-primary, .btn-reload { padding: 11px 20px; font-size: 14px; }
            table { font-size: 12px; }
            thead th, tbody td { padding: 8px; }
        }
    </style>
</head>
<body>

<!-- ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<nav>
    <div class="nav-inner">
        <span class="nav-logo">üìà StockDash</span>
        <button class="nav-btn active" id="navHome" onclick="showPage('home')">Stock Search</button>
        <button class="nav-btn" id="navHalts" onclick="showPage('halts')">üö´ Trading Halts</button>
    </div>
</nav>

<!-- ‚îÄ‚îÄ HOME PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="page active" id="pageHome">
    <div class="inner">
        <div class="card">
            <h2>üîç Stock Search</h2>
            <div class="search-bar">
                <input type="text" id="tickerInput" placeholder="Enter ticker (e.g. ATOM, AAPL, TSLA)" value="GXAI">
                <button class="btn-primary" id="searchBtn" onclick="searchStock()">Search</button>
            </div>
            <div class="loading" id="stockLoading"><div class="spinner"></div>Fetching data...</div>
            <div class="error-box" id="stockError"></div>
        </div>

        <div id="stockResults" style="display:none">
            <div class="card">
                <h2>üìä Stock Statistics</h2>
                <div class="stat-grid" id="statsGrid"></div>
            </div>
            <div class="card">
                <h2>üì∞ Latest News</h2>
                <div id="newsContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- ‚îÄ‚îÄ HALTS PAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="page" id="pageHalts">
    <div class="inner">
        <div class="card">
            <div class="halts-header">
                <div>
                    <h2>üö´ Trading Halts</h2>
                    <div class="halts-meta" id="haltsMeta">Loading...</div>
                </div>
                <button class="btn-reload" id="reloadBtn" onclick="loadHalts(false); startAutoRefresh();">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M1 4v6h6"/><path d="M23 20v-6h-6"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                    Reload
                </button>
            </div>

            <!-- Legend -->
            <div class="legend">
                <strong style="color:#333">Halt Types:</strong>
                <span class="legend-item"><span class="halt-type luld">LULD</span> Limit Up/Limit Down volatility pause ‚Äî resumes in 5 min increments (max 10 min)</span>
                <span class="legend-item"><span class="halt-type news">News</span> News Pending/Dissemination ‚Äî resumes after news released (minutes to hours)</span>
                <span class="legend-item"><span class="halt-type regulatory">Regulatory</span> SEC/Regulatory concern ‚Äî can last 10 trading days</span>
            </div>

            <!-- Filters -->
            <div class="halts-filters">
                <button class="filter-btn active" onclick="filterHalts('all', this)">All</button>
                <button class="filter-btn" onclick="filterHalts('luld', this)">LULD Only</button>
                <button class="filter-btn" onclick="filterHalts('news', this)">News Only</button>
                <button class="filter-btn" onclick="filterHalts('regulatory', this)">Regulatory</button>
                <button class="filter-btn" onclick="filterHalts('active', this)">üî¥ Still Halted</button>
                <button class="filter-btn" onclick="filterHalts('resumed', this)">‚úÖ Resumed</button>
            </div>

            <div class="halts-loading" id="haltsLoading">
                <div class="spinner" style="margin:0 auto 10px"></div>
                Loading halts data...
            </div>
            <div class="error-box" id="haltsError"></div>

            <div class="halts-table-wrap">
                <table id="haltsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Halt Time</th>
                            <th>Symbol</th>
                            <th>Company</th>
                            <th>Exchange</th>
                            <th>Reason</th>
                            <th>Resume Time</th>
                            <th>Est. Resumption (5 / 10 min)</th>
                        </tr>
                    </thead>
                    <tbody id="haltsBody"></tbody>
                </table>
                <div class="empty-state" id="haltsEmpty" style="display:none">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                    </svg>
                    <p>No halts match this filter.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));

    if (page === 'home') {
        document.getElementById('pageHome').classList.add('active');
        document.getElementById('navHome').classList.add('active');
        stopAutoRefresh(); // no need to poll when not on halts tab
    } else {
        document.getElementById('pageHalts').classList.add('active');
        document.getElementById('navHalts').classList.add('active');
        loadHalts(false);      // immediate full load
        startAutoRefresh();    // then poll every 30s silently
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STOCK SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const tickerInput   = document.getElementById('tickerInput');
const stockLoading  = document.getElementById('stockLoading');
const stockError    = document.getElementById('stockError');
const stockResults  = document.getElementById('stockResults');
const statsGrid     = document.getElementById('statsGrid');
const newsContainer = document.getElementById('newsContainer');

tickerInput.addEventListener('keypress', e => { if (e.key === 'Enter') searchStock(); });

async function fetchWithTimeout(url, ms = 8000) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try {
        const r = await fetch(url, { signal: ctrl.signal });
        clearTimeout(t);
        return r;
    } catch(e) { clearTimeout(t); throw e; }
}

async function fetchHtml(url) {
    const proxies = [
        `https://corsproxy.io/?${encodeURIComponent(url)}`,
        `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
        `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
        `https://thingproxy.freeboard.io/fetch/${url}`,
    ];
    for (let i = 0; i < proxies.length; i++) {
        try {
            const r = await fetchWithTimeout(proxies[i], 8000);
            if (r.ok) {
                const t = await r.text();
                if (t && t.length > 500) return t;
            }
        } catch(e) { console.log(`Proxy ${i+1} failed:`, e.message); }
    }
    throw new Error('All proxies failed. Try again in a moment.');
}

async function searchStock() {
    const ticker = tickerInput.value.trim().toUpperCase();
    if (!ticker) { showStockError('Please enter a stock ticker'); return; }

    stockLoading.classList.add('active');
    stockError.classList.remove('active');
    stockResults.style.display = 'none';
    document.getElementById('searchBtn').disabled = true;

    try {
        const html = await fetchHtml(`https://www.stocktitan.net/overview/${ticker}/`);
        const doc  = new DOMParser().parseFromString(html, 'text/html');
        const news = extractNews(doc, ticker);
        const stats = extractStats(doc);

        if (news.length === 0 && Object.keys(stats).length === 0)
            throw new Error(`No data found for "${ticker}".`);

        displayStats(stats, ticker);
        displayNews(news);
        stockResults.style.display = 'block';
    } catch(err) {
        showStockError(err.message);
    } finally {
        stockLoading.classList.remove('active');
        document.getElementById('searchBtn').disabled = false;
    }
}

function extractNews(doc, ticker) {
    const items = [], seen = new Set();

    // Strategy A: h3 > a[href*="/news/"]
    doc.querySelectorAll('h3').forEach(h3 => {
        const anchor = h3.querySelector('a[href*="/news/"]');
        if (!anchor) return;
        const title = anchor.textContent.trim();
        if (!title || seen.has(title)) return;
        seen.add(title);
        const href = anchor.getAttribute('href') || '';
        const link = href.startsWith('http') ? href : `https://www.stocktitan.net${href}`;
        let time = '', impactText = '', isPositive = false;
        let prev = h3.previousElementSibling;
        for (let i = 0; i < 6 && prev; i++) {
            const txt = prev.textContent.trim();
            if (!impactText && /^[+\-]\d+(\.\d+)?%$/.test(txt)) { impactText = txt; isPositive = txt.startsWith('+'); }
            if (!time && /(\d+\s+(second|minute|hour|day|week|month)s?\s+ago|january|february|march|april|may|june|july|august|september|october|november|december)\b/i.test(txt)) time = txt;
            prev = prev.previousElementSibling;
        }
        const tags = [];
        let next = h3.nextElementSibling;
        for (let i = 0; i < 4 && next; i++) {
            if (next.tagName === 'H3') break;
            next.querySelectorAll('a[href*="/news/"]').forEach(a => { const t = a.textContent.trim(); if (t && t.length < 40 && t !== title) tags.push(t); });
            next = next.nextElementSibling;
        }
        items.push({ time: time || 'Unknown', title, link, impact: impactText ? { value: impactText, isPositive } : null, tags });
    });

    // Strategy B: anchor href matches /news/TICKER/
    if (items.length === 0) {
        doc.querySelectorAll(`a[href*="/news/${ticker}/"]`).forEach(anchor => {
            const title = anchor.textContent.trim();
            if (!title || title.length < 10 || seen.has(title)) return;
            seen.add(title);
            const href = anchor.getAttribute('href') || '';
            const link = href.startsWith('http') ? href : `https://www.stocktitan.net${href}`;
            let container = anchor.parentElement;
            for (let i = 0; i < 3; i++) { if (container && container.children.length > 1) break; container = container?.parentElement; }
            let time = '', impactText = '', isPositive = false;
            if (container) {
                const ct = container.textContent;
                const tm = ct.match(/(\d+\s+(?:second|minute|hour|day|week|month)s?\s+ago|(?:january|february|march|april|may|june|july|august|september|october|november|december)\s+\d+,?\s*\d*)/i);
                const im = ct.match(/([+\-]\d+(\.\d+)?%)/);
                if (tm) time = tm[1];
                if (im) { impactText = im[1]; isPositive = im[1].startsWith('+'); }
            }
            items.push({ time: time || 'Unknown', title, link, impact: impactText ? { value: impactText, isPositive } : null, tags: [] });
        });
    }

    // Strategy C: any /news/TICKER/ anchor with long title
    if (items.length === 0) {
        doc.querySelectorAll('a[href*="/news/"]').forEach(anchor => {
            const title = anchor.textContent.trim();
            if (!title || title.length < 20 || !title.includes(' ') || seen.has(title)) return;
            const href = anchor.getAttribute('href') || '';
            if (!href.match(/\/news\/[A-Z]+\//)) return;
            seen.add(title);
            const link = href.startsWith('http') ? href : `https://www.stocktitan.net${href}`;
            items.push({ time: 'Unknown', title, link, impact: null, tags: [] });
        });
    }
    return items;
}

function extractStats(doc) {
    const stats = {}, body = doc.body ? doc.body.innerHTML : '';
    const regexMap = [
        ['Price',              /current stock price[^$]*\$([0-9,\.]+)/i,               '$'],
        ['Market Cap',         /market cap[^i]*is approximately ([0-9,\.\$MBKTmbt]+)/i, ''],
        ['Shares Outstanding', /shares outstanding[^i]*is ([0-9,\.MBKTmbt]+)/i,         ''],
        ['Revenue (TTM)',      /revenue.*?TTM.*?is \$([0-9,\.MBKTmbt]+)/i,              '$'],
        ['Net Income (TTM)',   /net income.*?TTM.*?is ([\-]?\$[0-9,\.MBKTmbt]+)/i,      ''],
        ['Diluted EPS',        /diluted.*?EPS.*?is (\$[0-9,\.\-]+)/i,                  ''],
        ['Operating CF',       /operating cash flow.*?is ([\-]?\$[0-9,\.MBKTmbt]+)/i,  ''],
        ['Net Profit Margin',  /net profit margin.*?is ([0-9\-\.]+%)/i,                ''],
        ['Short Interest',     /short interest[^s]*stands at ([0-9,\.]+ (?:thousand|million|billion)? shares)/i, ''],
        ['Float (Short %)',    /([0-9,\.]+%)\s+of the float/i,                         ''],
        ['Days to Cover',      /days to cover[^s]*stands at ([0-9,\.]+ days)/i,        ''],
        ['Current Ratio',      /current ratio[^i]*is ([0-9,\.]+)/i,                   ''],
    ];
    regexMap.forEach(([label, regex, prefix]) => {
        const m = body.match(regex);
        if (m && m[1] && typeof m[1] === 'string') stats[label] = (prefix + m[1].trim()).trim();
    });
    doc.querySelectorAll('dl').forEach(dl => {
        const dts = dl.querySelectorAll('dt'), dds = dl.querySelectorAll('dd');
        for (let i = 0; i < Math.min(dts.length, dds.length); i++) {
            const k = dts[i].textContent.trim(), v = dds[i].textContent.trim();
            if (k && v && !stats[k]) stats[k] = v;
        }
    });
    return stats;
}

function displayStats(stats, ticker) {
    statsGrid.innerHTML = '';
    const add = (label, value, highlight = false) => {
        const el = document.createElement('div');
        el.className = 'stat-item';
        if (highlight) {
            el.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            el.innerHTML = `<div class="stat-label" style="color:white">üìä ${label}</div><div class="stat-value" style="color:white;font-size:26px">${value}</div>`;
        } else {
            el.innerHTML = `<div class="stat-label">${label}</div><div class="stat-value">${value}</div>`;
        }
        statsGrid.appendChild(el);
    };
    add('Ticker', ticker);
    if (!Object.keys(stats).length) { add('Status', 'No Stats Found'); return; }
    const priority = ['Price','Market Cap','Shares Outstanding','Float','Short Interest','Float (Short %)','Days to Cover','Revenue (TTM)','Net Income (TTM)','Diluted EPS','Operating CF','Net Profit Margin','Current Ratio'];
    Object.entries(stats)
        .sort((a, b) => { const ai = priority.findIndex(p => a[0].includes(p)), bi = priority.findIndex(p => b[0].includes(p)); return (ai===-1?99:ai) - (bi===-1?99:bi); })
        .forEach(([label, value]) => {
            const sv = String(value).trim();
            if (sv && sv !== 'null') add(label, sv, label.toLowerCase().includes('float'));
        });
}

function displayNews(items) {
    newsContainer.innerHTML = '';
    if (!items.length) { newsContainer.innerHTML = '<p style="color:#aaa;text-align:center;padding:32px">No news found.</p>'; return; }
    items.forEach(n => {
        const el = document.createElement('div');
        el.className = 'news-item';
        const impact = n.impact ? `<div class="price-impact ${n.impact.isPositive?'positive':'negative'}">${n.impact.isPositive?'‚ñ≤':'‚ñº'} ${n.impact.value}</div>` : '';
        const tags = n.tags.length ? `<div class="news-tags">${n.tags.map(t=>`<span class="badge">${t}</span>`).join('')}</div>` : '';
        el.innerHTML = `<div class="news-meta"><div class="news-time">üïê ${n.time}</div>${impact}</div><h3 class="news-title"><a href="${n.link}" target="_blank">${n.title}</a></h3>${tags}`;
        newsContainer.appendChild(el);
    });
}

function showStockError(msg) {
    stockError.textContent = msg;
    stockError.classList.add('active');
    stockResults.style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADING HALTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let allHalts = [];
let haltsLoaded = false;
let currentFilter = 'all';

function estimateLuldResumption(haltTimeStr) {
    try {
        const [h, m, s] = haltTimeStr.split(':').map(Number);
        const fmt = dt => dt.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) + ' ET';
        const d5 = new Date(); d5.setHours(h, m + 5, s, 0);
        const d10 = new Date(); d10.setHours(h, m + 10, s, 0);
        return { five: fmt(d5), ten: fmt(d10) };
    } catch { return null; }
}

// NYSE reason codes reference:
// LULD/volatility: T1 (volatility trading pause), T2 (non-reg halt), T5 (single stock circuit breaker),
//                  T6 (extraordinary market activity), LUDP (LULD pause), M (LULD), MWC (market-wide circuit)
// News: H10 (SEC halt - news), H11 (SEC halt - info requested), T3 (news pending), T7 (news dissemination),
//       T8 (ETF component), T12 (additional info requested)
// Regulatory: H4 (SEC trading suspension), H9 (not current with requirements), R4, R9, C11
// IPO/Opening: IPO1, M1, M2 (pre-opening)
function getHaltTypeBadge(reason) {
    const r = (reason || '').toUpperCase().trim();
    const rl = r.toLowerCase();

    // LULD / volatility codes
    if (['T1','T2','T5','T6','LUDP','M','MWC1','MWC2','MWC3','MWC4'].includes(r) ||
        rl.includes('luld') || rl.includes('limit up') || rl.includes('limit down') ||
        rl.includes('volatility') || rl.includes('circuit breaker') || rl.includes('pause')) {
        return { cls: 'luld', label: 'LULD' };
    }

    // News codes
    if (['T3','T7','T8','T12','H10','H11'].includes(r) ||
        rl.includes('news') || rl.includes('information requested') || rl.includes('additional info')) {
        return { cls: 'news', label: 'News' };
    }

    // Regulatory / SEC suspension codes
    if (['H4','H9','R4','R9','C11','D','U1'].includes(r) ||
        rl.includes('regulat') || rl.includes('sec') || rl.includes('suspension') || rl.includes('concern')) {
        return { cls: 'regulatory', label: 'Regulatory' };
    }

    // IPO / opening
    if (['IPO1','M1','M2'].includes(r) || rl.includes('ipo') || rl.includes('listing')) {
        return { cls: 'other', label: 'IPO/Open' };
    }

    return { cls: 'other', label: r || 'Other' };
}

// Same comprehensive matching for resumption info
function getHaltInfo(reason, haltTime, resumeTime) {
    const r = (reason || '').toUpperCase().trim();
    const rl = r.toLowerCase();

    if (resumeTime && resumeTime.trim()) {
        return { label: '‚úÖ ' + resumeTime, cls: 'resumed' };
    }

    const isLuld = ['T1','T2','T5','T6','LUDP','M','MWC1','MWC2','MWC3','MWC4'].includes(r) ||
        rl.includes('luld') || rl.includes('limit') || rl.includes('volatility') ||
        rl.includes('circuit') || rl.includes('pause');

    const isNews = ['T3','T7','T8','T12','H10','H11'].includes(r) || rl.includes('news');
    const isPending = r === 'T3' || rl.includes('news pending');
    const isDissem  = r === 'T7' || rl.includes('dissemination');
    const isRegulatory = ['H4','H9','R4','R9','C11','D','U1'].includes(r) ||
        rl.includes('regulat') || rl.includes('sec') || rl.includes('suspension') || rl.includes('concern');

    if (isLuld) {
        const est = estimateLuldResumption(haltTime);
        if (est) return { label: `‚è± ${est.five} / ${est.ten}`, five: est.five, ten: est.ten, cls: 'estimated' };
        return { label: '+5 min / +10 min', cls: 'estimated' };
    }
    if (isPending)    return { label: 'üì∞ Awaiting news release', cls: 'pending' };
    if (isDissem)     return { label: 'üì∞ ~15‚Äì60 min', cls: 'pending' };
    if (isNews)       return { label: 'üì∞ Pending news', cls: 'pending' };
    if (isRegulatory) return { label: '‚õî Up to 10 days', cls: 'indefinite' };
    if (rl.includes('ipo') || rl.includes('listing')) return { label: '~30‚Äì60 min', cls: 'estimated' };

    return { label: 'Unknown', cls: 'pending' };
}

let autoRefreshTimer = null;
const AUTO_REFRESH_MS = 30000; // poll every 30 seconds

async function loadHalts(silent = false) {
    const reloadBtn = document.getElementById('reloadBtn');
    const haltsLoading = document.getElementById('haltsLoading');
    const haltsError = document.getElementById('haltsError');

    // Silent refresh (auto-poll): don't clear the table or show spinner
    if (!silent) {
        reloadBtn.disabled = true;
        reloadBtn.classList.add('spinning');
        haltsLoading.classList.add('active');
        haltsError.classList.remove('active');
        document.getElementById('haltsBody').innerHTML = '';
        document.getElementById('haltsEmpty').style.display = 'none';
    } else {
        reloadBtn.classList.add('spinning');
    }

    try {
        const csvUrl = 'https://www.nyse.com/api/trade-halts/current/download';
        let csvText = null;

        // Try direct first (fast ‚Äî works when served over HTTP with CORS blocker active)
        try {
            const res = await fetchWithTimeout(csvUrl, 4000);
            if (res.ok) {
                const text = await res.text();
                if (text && text.length > 10) csvText = text;
            }
        } catch(e) {
            console.log('Direct fetch blocked, trying proxies...', e.message);
        }

        // Fall back to proxies if direct failed (file:// or no CORS blocker)
        if (!csvText) {
            const proxies = [
                `https://corsproxy.io/?${encodeURIComponent(csvUrl)}`,
                `https://api.allorigins.win/raw?url=${encodeURIComponent(csvUrl)}`,
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(csvUrl)}`,
            ];
            for (const proxy of proxies) {
                try {
                    const res = await fetchWithTimeout(proxy, 7000);
                    if (res.ok) {
                        const text = await res.text();
                        if (text && text.length > 10) { csvText = text; break; }
                    }
                } catch(e) { console.log('Proxy failed:', e.message); }
            }
        }

        if (!csvText) throw new Error('Could not reach NYSE. Try serving this file over HTTP (see instructions below).');

        // DEBUG ‚Äî log raw CSV to console so we can see what NYSE is returning
        console.log('[Halts] Raw CSV length:', csvText.length);
        console.log('[Halts] First 500 chars:', csvText.slice(0, 500));
        console.log('[Halts] Last 200 chars:', csvText.slice(-200));

        const fresh = parseHaltsCsv(csvText);

        // Detect new halts since last load (for silent refreshes)
        if (silent && allHalts.length > 0) {
            const existing = new Set(allHalts.map(h => `${h.symbol}-${h.haltTime}`));
            const newHalts = fresh.filter(h => !existing.has(`${h.symbol}-${h.haltTime}`));
            if (newHalts.length > 0) {
                flashNewHalts(newHalts);
            } else {
                // Nothing new ‚Äî just update the timestamp quietly
                updateMeta(fresh.length, true);
                return;
            }
        }

        allHalts = fresh;
        haltsLoaded = true;
        updateMeta(allHalts.length, false);
        renderHalts(currentFilter);
        haltsError.classList.remove('active');

    } catch(err) {
        console.error('Halts fetch error:', err.message);
        if (!silent) {
            haltsError.innerHTML = `
                <strong>Could not fetch live halt data.</strong> ${err.message}<br><br>
                <strong>Fix:</strong> You need to serve this file over HTTP instead of opening it directly.<br>
                Open a terminal in this file's folder and run:<br>
                <code style="background:#f4f4f4;padding:4px 8px;border-radius:4px;display:inline-block;margin-top:6px">
                    npx serve .
                </code>
                &nbsp; or &nbsp;
                <code style="background:#f4f4f4;padding:4px 8px;border-radius:4px;display:inline-block;margin-top:6px">
                    python -m http.server 8080
                </code>
                <br>Then open <strong>http://localhost:8080</strong> in your browser. Your CORS blocker will work there.
            `;
            haltsError.classList.add('active');

        }
        // On silent fail, just skip ‚Äî keep existing data, try again next cycle
    } finally {
        haltsLoading.classList.remove('active');
        reloadBtn.disabled = false;
        reloadBtn.classList.remove('spinning');
    }
}

function updateMeta(count, noChange) {
    const time = new Date().toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true });
    const status = noChange ? ' ¬∑ No new halts' : '';
    document.getElementById('haltsMeta').textContent =
        `${count} halts ¬∑ Last checked ${time} ET${status} ¬∑ Auto-refreshing every 30s`;
}

function flashNewHalts(newHalts) {
    // Merge new halts to top, re-render, then highlight the new rows briefly
    allHalts = [...newHalts, ...allHalts];
    renderHalts(currentFilter);
    updateMeta(allHalts.length, false);

    // Flash the new rows green
    const rows = document.querySelectorAll('#haltsBody tr');
    for (let i = 0; i < Math.min(newHalts.length, rows.length); i++) {
        rows[i].style.transition = 'background 0.3s';
        rows[i].style.background = '#d4edda';
        setTimeout(() => { rows[i].style.background = ''; }, 2500);
    }

    // Also flash the nav button to alert user
    const navBtn = document.getElementById('navHalts');
    navBtn.textContent = `üö® Trading Halts (${newHalts.length} new)`;
    setTimeout(() => { navBtn.textContent = 'üö´ Trading Halts'; }, 5000);
}

function startAutoRefresh() {
    stopAutoRefresh();
    autoRefreshTimer = setInterval(() => loadHalts(true), AUTO_REFRESH_MS);
}

function stopAutoRefresh() {
    if (autoRefreshTimer) { clearInterval(autoRefreshTimer); autoRefreshTimer = null; }
}

// Properly parse a CSV line respecting quoted fields (handles "Company, Inc." correctly)
function parseCsvLine(line, delim) {
    if (delim !== ',') return line.split(delim).map(c => c.trim().replace(/^"|"$/g, ''));
    const result = [];
    let cur = '', inQuotes = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') {
            if (inQuotes && line[i+1] === '"') { cur += '"'; i++; }
            else inQuotes = !inQuotes;
        } else if (ch === ',' && !inQuotes) {
            result.push(cur.trim()); cur = '';
        } else {
            cur += ch;
        }
    }
    result.push(cur.trim());
    return result;
}

function parseHaltsCsv(csv) {
    const lines = csv.trim().split('\n');
    if (lines.length < 2) return [];

    const firstLine = lines[0];
    const delim = firstLine.includes('|') ? '|' : ',';
    const headers = parseCsvLine(firstLine, delim).map(h => h.replace(/"/g,'').toLowerCase().trim());
    console.log('[Halts] CSV headers:', headers);

    const rows = [];
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const cells = parseCsvLine(line, delim);
        if (cells.length < 3) continue;
        const row = {};
        headers.forEach((h, idx) => { row[h] = (cells[idx] || '').trim(); });

        rows.push({
            date:       row['halt date'] || row['date'] || '',
            haltTime:   row['halt time'] || row['time'] || '',
            symbol:     row['symbol'] || row['ticker'] || '',
            name:       row['name'] || row['company name'] || row['company'] || '',
            exchange:   row['market'] || row['exchange'] || row['mkt'] || '',
            reason:     row['reason code'] || row['reason'] || row['halt reason'] || '',
            resumeDate: row['resume date'] || row['resumption date'] || '',
            resumeTime: row['nyse resume time'] || row['resume time'] || row['resumption time'] || row['resume trade time'] || '',
        });
    }

    return rows.sort((a, b) => {
        const da = new Date(`${a.date} ${a.haltTime}`);
        const db = new Date(`${b.date} ${b.haltTime}`);
        return db - da;
    });
}

function renderHalts(filter) {
    currentFilter = filter;
    const tbody = document.getElementById('haltsBody');
    const empty = document.getElementById('haltsEmpty');
    tbody.innerHTML = '';

    const LULD_CODES = ['T1','T2','T5','T6','LUDP','M','MWC1','MWC2','MWC3','MWC4'];
    const NEWS_CODES  = ['T3','T7','T8','T12','H10','H11'];
    const REG_CODES   = ['H4','H9','R4','R9','C11','D','U1'];

    const isLuld = h => {
        const r = (h.reason||'').toUpperCase().trim();
        return LULD_CODES.includes(r) || /luld|limit|volatil|circuit|pause/i.test(h.reason);
    };
    const isNews = h => {
        const r = (h.reason||'').toUpperCase().trim();
        return NEWS_CODES.includes(r) || /news/i.test(h.reason);
    };
    const isReg = h => {
        const r = (h.reason||'').toUpperCase().trim();
        return REG_CODES.includes(r) || /regulat|sec|suspension|concern/i.test(h.reason);
    };

    let filtered = allHalts;
    if (filter === 'luld') filtered = allHalts.filter(isLuld);
    else if (filter === 'news') filtered = allHalts.filter(isNews);
    else if (filter === 'regulatory') filtered = allHalts.filter(isReg);
    else if (filter === 'active') filtered = allHalts.filter(h => !h.resumeTime || !h.resumeTime.trim());
    else if (filter === 'resumed') filtered = allHalts.filter(h => h.resumeTime && h.resumeTime.trim());

    if (!filtered.length) { empty.style.display = 'block'; return; }
    empty.style.display = 'none';

    filtered.forEach(halt => {
        const tr = document.createElement('tr');
        const typeBadge = getHaltTypeBadge(halt.reason);
        const resumption = getHaltInfo(halt.reason, halt.haltTime, halt.resumeTime);

        tr.innerHTML = `
            <td>${halt.date || '‚Äî'}</td>
            <td>${halt.haltTime || '‚Äî'}</td>
            <td><span class="ticker-chip">${halt.symbol || '‚Äî'}</span></td>
            <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${halt.name}">${halt.name || '‚Äî'}</td>
            <td>${halt.exchange || '‚Äî'}</td>
            <td>
                <span class="halt-type ${typeBadge.cls}">${typeBadge.label}</span>
                <div style="font-size:11px;color:#888;margin-top:3px">${halt.reason}</div>
            </td>
            <td>${halt.resumeTime || '<span style="color:#aaa">‚Äî</span>'}</td>
            <td>${resumption.five && resumption.ten
                ? `<div style="display:flex;flex-direction:column;gap:4px">
                     <span class="resumption-badge estimated" title="5-min resumption">‚è± 5min: ${resumption.five}</span>
                     <span class="resumption-badge estimated" style="opacity:0.7" title="10-min resumption if extended">‚è± 10min: ${resumption.ten}</span>
                   </div>`
                : `<span class="resumption-badge ${resumption.cls}">${resumption.label}</span>`
            }</td>
        `;
        tbody.appendChild(tr);
    });
}

function filterHalts(filter, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderHalts(filter);
}


// Auto-search on load
window.addEventListener('load', () => searchStock());
</script>
</body>
</html>
